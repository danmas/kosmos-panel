name: git-safe-merge-dev-into-main
description: |
  Безопасное слияние ветки dev в main:
  • проверяет, что ты на dev
  • коммитит незакоммиченные изменения (если пользователь разрешит)
  • проверяет чистоту main
  • делает merge dev → main
  • пушит main
  • возвращается на dev
version: 1.0.0
tags: [git, merge, workflow, release, safe]
triggers:
  - merge dev to main
  - слить dev в main
  - update main from dev
  - подтянуть dev в мейн
  - release dev
  - deploy dev to production
---

# git-safe-merge-dev-into-main

## Когда использовать этот skill
Когда пользователь явно хочет слить изменения из ветки `dev` в `main` / `master`.

Примеры фраз, которые должны активировать этот навык:
- слей dev в main
- merge dev to main пожалуйста
- обнови main из dev
- подтяни dev в мейн и запушь
- release dev в прод

## Строгий порядок выполнения (не пропускать и не менять последовательность!)

1. Определить текущую ветку  
   Выполни:  
   ```bash
   git branch --show-current
   ```  
   → Если результат **не** `dev` → сразу ответить:  
   ```
   Ошибка: ты сейчас не на ветке dev.
   Текущая ветка: <результат команды>
   Переключись на dev (git checkout dev) и повтори запрос.
   ```  
   → и **полностью остановиться**.

2. Проверить наличие незакоммиченных изменений на dev  
   Выполни:  
   ```bash
   git status --short
   ```  
   Если вывод **не пустой** (есть изменённые/новые/удалённые файлы):  
   - Спросить пользователя:  
     ```
     На ветке dev есть незакоммиченные изменения:
     <вставить вывод git status --short>

     Хочешь закоммитить их перед слиянием?
     Если да — напиши сообщение для коммита (можно короткое).
     Если нет — процесс будет остановлен.
     ```  
   - Дождаться ответа.  
   - Если пользователь дал сообщение → выполнить:  
     ```bash
     git commit -am "<вставленное сообщение>"
     ```  
     Показать результат команды.  
   - Если пользователь отказался / не дал сообщение → ответить:  
     ```
     Процесс остановлен: есть незакоммиченные изменения, но коммит не сделан.
     ```  
     → и **остановиться**.

3. Переключиться на main  
   ```bash
   git checkout main
   ```  
   (или `master`, если main не существует — проверить заранее через `git branch`)

4. Убедиться, что main чистая  
   ```bash
   git status --short
   ```  
   Если вывод **не пустой** → ответить:  
   ```
   Ошибка: ветка main (или master) не чистая!
   <вставить вывод git status --short>

   Пожалуйста, закоммить или сбросить изменения на main перед слиянием.
   ```  
   → и **остановиться**.

5. (Опционально, но очень рекомендуется) Подтянуть актуальный main с удалённого  
   ```bash
   git pull origin main --ff-only
   ```  
   Если команда завершилась с ошибкой (не fast-forward) → сообщить и остановиться.

6. Выполнить слияние  
   ```bash
   git merge dev --no-ff --no-edit
   ```  
   - Если возник конфликт → сообщить:  
     ```
     Конфликт слияния! Нужно разрешить конфликты вручную.

     После разрешения:
     git add <файлы>
     git commit
     git push origin main
     ```  
     → и **остановиться**.  
   - Если слияние прошло чисто → продолжить.

7. Запушить изменения в main  
   ```bash
   git push origin main
   ```  
   Если push отклонён → сообщить причину и остановиться.

8. Вернуться обратно на dev  
   ```bash
   git checkout dev
   ```

9. Сообщить об успешном завершении  
   ```
   Успешно выполнено:

   • текущая ветка была dev
   • незакоммиченные изменения на dev → закоммичены (если были)
   • main была чистой
   • dev успешно слита в main
   • изменения запушены в origin/main
   • вернулись обратно на ветку dev

   Готов к следующей задаче.
   ```

## Важные запреты и правила безопасности
- Перед выполнением каждого значимого шага (команды) обязательно используй формат `[MESSAGE]`, чтобы кратко объяснить пользователю, что ты сейчас сделаешь.
- Никогда не используй --force / --force-with-lease при push
- Не делай rebase вместо merge без явного разрешения
- Не удаляй ветку dev
- Не продолжай выполнение после любой ошибки
- Всегда показывай пользователю вывод важных команд (status, merge, push и т.д.)
- Если основная ветка называется master вместо main — адаптируйся автоматически

Удачного и безопасного релиза!
