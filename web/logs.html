<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>–õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html, body { 
        height: 100%; 
        margin: 0; 
        background: #0b0f1a; 
        color: #e6ecff; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .wrap { 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
      }
      .header { 
        padding: 12px 16px; 
        background: #0e1322; 
        border-bottom: 1px solid #1c2333; 
        display: flex; 
        gap: 12px; 
        align-items: center;
        justify-content: space-between;
      }
      .header-left {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .header-title { 
        font-weight: 700; 
        font-size: 16px;
      }
      .session-info {
        font-size: 12px;
        color: #4a9eff;
        font-family: monospace;
        background: rgba(74, 158, 255, 0.1);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid rgba(74, 158, 255, 0.3);
      }
      .session-filter {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .session-filter label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #a0aec0;
        cursor: pointer;
        user-select: none;
      }
      .session-filter input[type="checkbox"] {
        cursor: pointer;
      }
      .log-entry-session {
        font-size: 11px;
        color: #666;
        margin-bottom: 4px;
      }
      .log-entry-session span {
        background: rgba(74, 158, 255, 0.15);
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 6px;
      }
      .filters {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .tabs {
        display: flex;
        gap: 4px;
        border-bottom: 1px solid #1c2333;
        padding: 0 16px;
        background: #0e1322;
      }
      .tab {
        background: transparent;
        border: none;
        color: #a0aec0;
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }
      .tab:hover {
        color: #e6ecff;
        background: rgba(255, 255, 255, 0.05);
      }
      .tab.active {
        color: #4a9eff;
        border-bottom-color: #4a9eff;
      }
      .filter-btn {
        background: #1b2544;
        border: 1px solid #223055;
        color: #e6ecff;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }
      .filter-btn:hover {
        background: #223055;
      }
      .filter-btn.active {
        background: #2d4a87;
        border-color: #4a9eff;
      }
      .status {
        font-size: 12px;
        color: #888;
      }
      .content { 
        flex: 1; 
        padding: 16px; 
        overflow-y: auto; 
      }
      .log-entry { 
        margin-bottom: 16px; 
      }
      .log-entry-type {
        color: #4a9eff;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .log-entry-content {
        background: #0b0f1a;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #4a9eff;
        white-space: pre-wrap;
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
      }
      .log-entry-content code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
      }
      .log-ai-query { border-left-color: #ffa500; }
      .log-ai-query .log-entry-type { color: #ffa500; }
      .log-stdin { border-left-color: #00ff00; }
      .log-stdin .log-entry-type { color: #00ff00; }
      .log-stdout { border-left-color: #4a9eff; }
      .log-stderr { border-left-color: #ef4444; }
      .log-stderr .log-entry-type { color: #ef4444; }
      .log-skill-start { border-left-color: #10b981; }
      .log-skill-start .log-entry-type { color: #10b981; }
      .log-skill-command { border-left-color: #8b5cf6; }
      .log-skill-command .log-entry-type { color: #8b5cf6; }
      .log-skill-message { border-left-color: #f59e0b; }
      .log-skill-message .log-entry-type { color: #f59e0b; }
      .log-skill-user-input { border-left-color: #06b6d4; }
      .log-skill-user-input .log-entry-type { color: #06b6d4; }
      .log-skill-complete { border-left-color: #22c55e; }
      .log-skill-complete .log-entry-type { color: #22c55e; }
      .empty {
        text-align: center;
        color: #888;
        margin-top: 50px;
        font-size: 14px;
      }
      .timestamp {
        font-size: 11px;
        color: #666;
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- –í–∫–ª–∞–¥–∫–∏ -->
      <div class="tabs">
        <button class="tab active" data-tab="terminal">üíª Terminal</button>
        <button class="tab" data-tab="skills">‚ú® Skills</button>
      </div>
      
      <div class="header">
        <div class="header-left">
          <div class="header-title" id="headerTitle">üìã –õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>
          <div class="session-filter">
            <div class="session-info" id="sessionInfo">Session: ...</div>
            <label title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π">
              <input type="checkbox" id="showAllSessions" />
              All
            </label>
          </div>
        </div>
        <div class="filters" id="terminalFilters">
          <button class="filter-btn active" data-type="all">–í—Å–µ</button>
          <button class="filter-btn" data-type="ai_query">AI</button>
          <button class="filter-btn" data-type="stdin">–ö–æ–º–∞–Ω–¥—ã</button>
          <button class="filter-btn" data-type="stdout">–í—ã–≤–æ–¥</button>
          <button class="filter-btn" data-type="stderr">–û—à–∏–±–∫–∏</button>
        </div>
        <div class="filters" id="skillsFilters" style="display: none;">
          <button class="filter-btn active" data-type="all">–í—Å–µ</button>
          <button class="filter-btn" data-type="skill_start">–ó–∞–ø—É—Å–∫</button>
          <button class="filter-btn" data-type="skill_command">–ö–æ–º–∞–Ω–¥—ã</button>
          <button class="filter-btn" data-type="skill_message">–í–æ–ø—Ä–æ—Å—ã</button>
          <button class="filter-btn" data-type="skill_user_input">–û—Ç–≤–µ—Ç—ã</button>
          <button class="filter-btn" data-type="skill_complete">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</button>
        </div>
        <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
      <div class="content" id="content">
        <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
      </div>
    </div>
    <script>
      const params = new URLSearchParams(location.search);
      const sessionId = params.get('sessionId');
      
      let currentTab = 'terminal'; // 'terminal' –∏–ª–∏ 'skills'
      let allLogs = [];
      let currentFilter = 'all';
      let lastUpdate = 0;
      let showAllSessions = false;
      
      if (!sessionId) {
        document.getElementById('sessionInfo').textContent = 'Session: –Ω–µ —É–∫–∞–∑–∞–Ω';
      } else {
        document.getElementById('sessionInfo').textContent = `Session: ${sessionId.substring(0, 8)}...`;
      }
      
      function stripAnsi(str) {
        return str.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
      }
      
      async function loadLogs() {
        if (!showAllSessions && !sessionId) return;
        
        try {
          const apiUrl = currentTab === 'skills' ? '/api/skills-logs' : '/api/logs';
          const url = showAllSessions
            ? `${apiUrl}?t=${Date.now()}`
            : `${apiUrl}?sessionId=${encodeURIComponent(sessionId)}&t=${Date.now()}`;
          const response = await fetch(url);
          const logs = await response.json();
          
          if (logs.length !== allLogs.length || (logs.length > 0 && logs[logs.length - 1].id !== allLogs[allLogs.length - 1]?.id)) {
            allLogs = logs;
            lastUpdate = Date.now();
            renderLogs();
            updateStatus();
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', err);
          document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
      }
      
      function updateStatus() {
        const statusEl = document.getElementById('status');
        const count = getFilteredLogs().length;
        const time = lastUpdate ? new Date(lastUpdate).toLocaleTimeString('ru-RU') : '';
        statusEl.textContent = `${count} –∑–∞–ø–∏—Å–µ–π${time ? ' ‚Ä¢ ' + time : ''}`;
      }
      
      function getFilteredLogs() {
        if (currentFilter === 'all') return allLogs;
        return allLogs.filter(log => log.type === currentFilter);
      }
      
      function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }
      
      function renderLogs() {
        const contentEl = document.getElementById('content');
        if (!showAllSessions && !sessionId) {
          contentEl.innerHTML = '<div class="empty">–£–∫–∞–∂–∏—Ç–µ sessionId –≤ URL –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ All –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤</div>';
          return;
        }
        const logs = getFilteredLogs();
        
        if (logs.length === 0) {
          contentEl.innerHTML = '<div class="empty">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
          return;
        }
        
        const html = logs.map(log => {
          if (currentTab === 'skills') {
            return renderSkillLog(log);
          } else {
            return renderTerminalLog(log);
          }
        }).join('');
        
        contentEl.innerHTML = html;
        
        // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ª–æ–≥—É –µ—Å–ª–∏ –≤–Ω–∏–∑—É
        const wasAtBottom = contentEl.scrollHeight - contentEl.scrollTop <= contentEl.clientHeight + 100;
        if (wasAtBottom) {
          contentEl.scrollTop = contentEl.scrollHeight;
        }
      }
      
      function renderTerminalLog(log) {
        let typeLabel, content, className;
        
        switch (log.type) {
          case 'ai_query':
            typeLabel = 'ü§ñ AI –ó–∞–ø—Ä–æ—Å';
            content = log.user_ai_query || '';
            className = 'log-ai-query';
            break;
          case 'stdin':
            typeLabel = '‚ö° –ö–æ–º–∞–Ω–¥–∞';
            content = log.executed_command || '';
            className = 'log-stdin';
            break;
          case 'stdout':
            typeLabel = 'üì§ –í—ã–≤–æ–¥';
            content = stripAnsi(log.terminal_output || '');
            className = 'log-stdout';
            break;
          case 'stderr':
            typeLabel = 'üî• –û—à–∏–±–∫–∞';
            content = stripAnsi(log.terminal_output || '');
            className = 'log-stderr';
            break;
          default:
            return '';
        }
        
        content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ru-RU') : '';
        const sessionBadge = showAllSessions && (log.serverName || log.sessionId)
          ? `<div class="log-entry-session"><span>${escapeHtml(log.serverName || log.serverId || '')}</span><span>${escapeHtml((log.sessionId || '').substring(0, 8))}‚Ä¶</span></div>`
          : '';
        return `
          <div class="log-entry ${className}">
            ${sessionBadge}
            <div class="log-entry-type">
              ${typeLabel}
              ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
            </div>
            <pre class="log-entry-content">${content}</pre>
          </div>
        `;
      }
      
      function renderSkillLog(log) {
        let typeLabel, content, className, extraInfo = '';
        
        switch (log.type) {
          case 'skill_start':
            typeLabel = '‚ú® –ó–∞–ø—É—Å–∫ Skill';
            content = `Skill: ${log.skill_name}\n${log.skill_description || ''}\n\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(log.skill_params, null, 2)}`;
            className = 'log-skill-start';
            break;
          case 'skill_command':
            typeLabel = 'üêö –ö–æ–º–∞–Ω–¥–∞';
            content = log.command || '';
            className = 'log-skill-command';
            extraInfo = `–®–∞–≥: ${log.step}`;
            break;
          case 'skill_message':
            typeLabel = '‚ùì –í–æ–ø—Ä–æ—Å AI';
            content = log.message || '';
            className = 'log-skill-message';
            extraInfo = `–®–∞–≥: ${log.step}`;
            break;
          case 'skill_user_input':
            typeLabel = 'üí¨ –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            content = log.user_input || '';
            className = 'log-skill-user-input';
            extraInfo = `–®–∞–≥: ${log.step}`;
            break;
          case 'skill_complete':
            typeLabel = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ';
            content = log.final_message || 'Skill completed';
            className = 'log-skill-complete';
            extraInfo = `–®–∞–≥: ${log.step}`;
            break;
          default:
            return '';
        }
        
        content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ru-RU') : '';
        const sessionBadge = showAllSessions && (log.serverName || log.session_id)
          ? `<div class="log-entry-session"><span>${escapeHtml(log.serverName || log.serverId || '')}</span><span>${escapeHtml((log.session_id || '').substring(0, 8))}‚Ä¶</span></div>`
          : '';
        const skillBadge = `<div class="log-entry-session"><span>üì¶ ${escapeHtml(log.skill_name)}</span>${extraInfo ? `<span>${extraInfo}</span>` : ''}</div>`;
        
        return `
          <div class="log-entry ${className}">
            ${sessionBadge}
            ${skillBadge}
            <div class="log-entry-type">
              ${typeLabel}
              ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
            </div>
            <pre class="log-entry-content">${content}</pre>
          </div>
        `;
      }
      
      // –ß–µ–∫–±–æ–∫—Å All ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è / –≤—Å–µ —Å–µ—Å—Å–∏–∏
      document.getElementById('showAllSessions').addEventListener('change', function() {
        showAllSessions = this.checked;
        loadLogs();
      });
      
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
          const tabName = tab.dataset.tab;
          if (tabName === currentTab) return;
          
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentTab = tabName;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
          const headerTitle = document.getElementById('headerTitle');
          if (tabName === 'skills') {
            headerTitle.textContent = '‚ú® –õ–æ–≥–∏ Skills';
          } else {
            headerTitle.textContent = 'üìã –õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞';
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
          document.getElementById('terminalFilters').style.display = tabName === 'terminal' ? 'flex' : 'none';
          document.getElementById('skillsFilters').style.display = tabName === 'skills' ? 'flex' : 'none';
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
          currentFilter = 'all';
          const activeFilters = tabName === 'terminal' ? '#terminalFilters .filter-btn' : '#skillsFilters .filter-btn';
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          document.querySelector(activeFilters + '[data-type="all"]').classList.add('active');
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
          allLogs = [];
          loadLogs();
        };
      });
      
      // –§–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.type;
          renderLogs();
          updateStatus();
        };
      });
      
      // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ sessionId) –∏ –∑–∞–≥—Ä—É–∑–∫–∞
      renderLogs();
      loadLogs();
      const intervalId = setInterval(loadLogs, 2000);
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
      window.addEventListener('beforeunload', () => {
        clearInterval(intervalId);
      });
    </script>
  </body>
</html>
