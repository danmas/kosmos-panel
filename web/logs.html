<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <title>–õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./themes.css" />
  <script src="./theme-manager.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg-main);
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .wrap {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 12px 16px;
      background: var(--bg-header);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .header-title {
      font-weight: 700;
      font-size: 16px;
    }

    .session-info {
      font-size: 12px;
      color: var(--primary);
      font-family: monospace;
      background: var(--primary-dim);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--primary-dim);
    }

    .session-filter {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .session-filter label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .session-filter input[type="checkbox"] {
      cursor: pointer;
    }

    .log-entry-session {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .log-entry-session span {
      background: var(--bg-hover);
      padding: 2px 6px;
      border-radius: 4px;
      margin-right: 6px;
    }

    .filters {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--border-light);
      padding: 0 16px;
      background: var(--bg-header);
    }

    .tab {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text-main);
      background: var(--bg-hover);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .filter-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      color: var(--text-main);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      background: var(--bg-hover);
    }

    .filter-btn.active {
      background: var(--primary-dim);
      border-color: var(--primary);
    }

    .status {
      font-size: 12px;
      color: var(--text-dim);
    }

    .content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 16px;
    }

    .log-entry-type {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .log-entry-content {
      background: var(--bg-main);
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--primary);
      white-space: pre-wrap;
      word-break: break-all;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry-content code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 4px;
      border-radius: 3px;
    }

    .log-ai-query {
      border-left-color: var(--log-ai);
    }

    .log-ai-query .log-entry-type {
      color: var(--log-ai);
    }

    .log-stdin {
      border-left-color: var(--log-stdin);
    }

    .log-stdin .log-entry-type {
      color: var(--log-stdin);
    }

    .log-stdout {
      border-left-color: var(--log-stdout);
    }

    .log-stderr {
      border-left-color: var(--log-stderr);
    }

    .log-stderr .log-entry-type {
      color: var(--log-stderr);
    }

    .log-skill-start {
      border-left-color: var(--log-skill-start);
    }

    .log-skill-start .log-entry-type {
      color: var(--log-skill-start);
    }

    .log-skill-command {
      border-left-color: var(--log-skill-cmd);
    }

    .log-skill-command .log-entry-type {
      color: var(--log-skill-cmd);
    }

    .log-skill-message {
      border-left-color: var(--log-skill-msg);
    }

    .log-skill-message .log-entry-type {
      color: var(--log-skill-msg);
    }

    .log-skill-command-output {
      border-left-color: var(--log-skill-output);
    }

    .log-skill-command-output .log-entry-type {
      color: var(--log-skill-output);
    }

    .log-skill-user-input {
      border-left-color: var(--log-skill-input);
    }

    .log-skill-user-input .log-entry-type {
      color: var(--log-skill-input);
    }

    .log-skill-ask {
      border-left-color: var(--log-skill-ask);
    }

    .log-skill-ask .log-entry-type {
      color: var(--log-skill-ask);
    }

    .log-skill-complete {
      border-left-color: var(--log-skill-complete);
    }

    .log-skill-complete .log-entry-type {
      color: var(--log-skill-complete);
    }

    .empty {
      text-align: center;
      color: var(--text-dim);
      margin-top: 50px;
      font-size: 14px;
    }

    .timestamp {
      font-size: 11px;
      color: var(--text-dim);
      margin-left: auto;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- –í–∫–ª–∞–¥–∫–∏ -->
    <div class="tabs">
      <button class="tab active" data-tab="terminal">üíª Terminal</button>
      <button class="tab" data-tab="skills">‚ú® Skills</button>
    </div>

    <div class="header">
      <div class="header-left">
        <div class="header-title" id="headerTitle">üìã –õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</div>
        <div class="session-filter">
          <div class="session-info" id="sessionInfo">Session: ...</div>
          <label title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π">
            <input type="checkbox" id="showAllSessions" />
            All
          </label>
        </div>
      </div>
      <div class="filters" id="terminalFilters">
        <button class="filter-btn active" data-type="all">–í—Å–µ</button>
        <button class="filter-btn" data-type="ai_query">AI</button>
        <button class="filter-btn" data-type="stdin">–ö–æ–º–∞–Ω–¥—ã</button>
        <button class="filter-btn" data-type="stdout">–í—ã–≤–æ–¥</button>
        <button class="filter-btn" data-type="stderr">–û—à–∏–±–∫–∏</button>
      </div>
      <div class="filters" id="skillsFilters" style="display: none;">
        <button class="filter-btn active" data-type="all">–í—Å–µ</button>
        <button class="filter-btn" data-type="skill_start">–ó–∞–ø—É—Å–∫</button>
        <button class="filter-btn" data-type="skill_command">–ö–æ–º–∞–Ω–¥—ã</button>
        <button class="filter-btn" data-type="skill_command_output">Output</button>
        <button class="filter-btn" data-type="skill_message">–ò–Ω—Ñ–æ</button>
        <button class="filter-btn" data-type="skill_ask">–í–æ–ø—Ä–æ—Å—ã</button>
        <button class="filter-btn" data-type="skill_user_input">–û—Ç–≤–µ—Ç—ã</button>
        <button class="filter-btn" data-type="skill_complete">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</button>
      </div>
      <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <div class="content" id="content">
      <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
    </div>
  </div>
  <script>
    const params = new URLSearchParams(location.search);
    const sessionId = params.get('sessionId');

    let currentTab = 'terminal'; // 'terminal' –∏–ª–∏ 'skills'
    let allLogs = [];
    let currentFilter = 'all';
    let lastUpdate = 0;
    let showAllSessions = false;

    if (!sessionId) {
      document.getElementById('sessionInfo').textContent = 'Session: –Ω–µ —É–∫–∞–∑–∞–Ω';
    } else {
      document.getElementById('sessionInfo').textContent = `Session: ${sessionId.substring(0, 8)}...`;
    }

    function stripAnsi(str) {
      return str.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
    }

    async function loadLogs() {
      if (!showAllSessions && !sessionId) return;

      try {
        const apiUrl = currentTab === 'skills' ? '/api/skills-logs' : '/api/logs';
        const url = showAllSessions
          ? `${apiUrl}?t=${Date.now()}`
          : `${apiUrl}?sessionId=${encodeURIComponent(sessionId)}&t=${Date.now()}`;
        const response = await fetch(url);
        const logs = await response.json();

        if (logs.length !== allLogs.length || (logs.length > 0 && logs[logs.length - 1].id !== allLogs[allLogs.length - 1]?.id)) {
          allLogs = logs;
          lastUpdate = Date.now();
          renderLogs();
          updateStatus();
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', err);
        document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      }
    }

    function updateStatus() {
      const statusEl = document.getElementById('status');
      const count = getFilteredLogs().length;
      const time = lastUpdate ? new Date(lastUpdate).toLocaleTimeString('ru-RU') : '';
      statusEl.textContent = `${count} –∑–∞–ø–∏—Å–µ–π${time ? ' ‚Ä¢ ' + time : ''}`;
    }

    function getFilteredLogs() {
      if (currentFilter === 'all') return allLogs;
      return allLogs.filter(log => log.type === currentFilter);
    }

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderLogs() {
      const contentEl = document.getElementById('content');
      if (!showAllSessions && !sessionId) {
        contentEl.innerHTML = '<div class="empty">–£–∫–∞–∂–∏—Ç–µ sessionId –≤ URL –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ All –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤</div>';
        return;
      }
      const logs = getFilteredLogs();

      if (logs.length === 0) {
        contentEl.innerHTML = '<div class="empty">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }

      const html = logs.map(log => {
        if (currentTab === 'skills') {
          return renderSkillLog(log);
        } else {
          return renderTerminalLog(log);
        }
      }).join('');

      contentEl.innerHTML = html;

      // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ª–æ–≥—É –µ—Å–ª–∏ –≤–Ω–∏–∑—É
      const wasAtBottom = contentEl.scrollHeight - contentEl.scrollTop <= contentEl.clientHeight + 100;
      if (wasAtBottom) {
        contentEl.scrollTop = contentEl.scrollHeight;
      }
    }

    function renderTerminalLog(log) {
      let typeLabel, content, className;

      switch (log.type) {
        case 'ai_query':
          typeLabel = 'ü§ñ AI –ó–∞–ø—Ä–æ—Å';
          content = log.user_ai_query || '';
          className = 'log-ai-query';
          break;
        case 'stdin':
          typeLabel = '‚ö° –ö–æ–º–∞–Ω–¥–∞';
          content = log.executed_command || '';
          className = 'log-stdin';
          break;
        case 'stdout':
          typeLabel = 'üì§ –í—ã–≤–æ–¥';
          content = stripAnsi(log.terminal_output || '');
          className = 'log-stdout';
          break;
        case 'stderr':
          typeLabel = 'üî• –û—à–∏–±–∫–∞';
          content = stripAnsi(log.terminal_output || '');
          className = 'log-stderr';
          break;
        default:
          return '';
      }

      content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ru-RU') : '';
      const sessionBadge = showAllSessions && (log.serverName || log.sessionId)
        ? `<div class="log-entry-session"><span>${escapeHtml(log.serverName || log.serverId || '')}</span><span>${escapeHtml((log.sessionId || '').substring(0, 8))}‚Ä¶</span></div>`
        : '';
      return `
          <div class="log-entry ${className}">
            ${sessionBadge}
            <div class="log-entry-type">
              ${typeLabel}
              ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
            </div>
            <pre class="log-entry-content">${content}</pre>
          </div>
        `;
    }

    function renderSkillLog(log) {
      let typeLabel, content, className, extraInfo = '';

      switch (log.type) {
        case 'skill_start':
          typeLabel = '‚ú® –ó–∞–ø—É—Å–∫ Skill';
          content = `Skill: ${log.skill_name}\n${log.skill_description || ''}\n\n–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(log.skill_params, null, 2)}`;
          // –î–æ–±–∞–≤–ª—è–µ–º AI –∫–æ–Ω—Ç–µ–∫—Å—Ç
          if (log.ai_system_prompt) {
            content += `\n\n--- AI System Prompt (preview) ---\n${log.ai_system_prompt}`;
          }
          className = 'log-skill-start';
          break;
        case 'skill_command':
          typeLabel = 'üêö –ö–æ–º–∞–Ω–¥–∞';
          content = log.command || '';
          // –î–æ–±–∞–≤–ª—è–µ–º user content –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω AI
          if (log.user_content_sent_to_ai) {
            content += `\n\n--- User Content Sent to AI ---\n${log.user_content_sent_to_ai}`;
          }
          // –î–æ–±–∞–≤–ª—è–µ–º AI response
          if (log.ai_full_response) {
            content += `\n\n--- AI Full Response ---\n${log.ai_full_response}`;
          }
          // –î–æ–±–∞–≤–ª—è–µ–º messages history
          if (log.ai_messages_history && log.ai_messages_history.length > 0) {
            content += `\n\n--- AI Messages History (${log.ai_messages_history.length} messages) ---\n`;
            log.ai_messages_history.forEach((m, i) => {
              content += `\n[${i + 1}] ${m.role}: ${m.content}`;
            });
          }
          className = 'log-skill-command';
          extraInfo = `–®–∞–≥: ${log.step}`;
          break;
        case 'skill_command_output':
          typeLabel = 'üì§ Command Output';
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ —Å—ã—Ä–æ–π –∏ –æ—á–∏—â–µ–Ω–Ω—ã–π output
          content = '';
          if (log.command_output_cleaned) {
            content += `--- Cleaned (sent to AI) ---\n${log.command_output_cleaned}`;
          }
          if (log.command_output_raw) {
            content += `\n\n--- Raw Output ---\n${log.command_output_raw}`;
          }
          // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (fallback)
          if (!content && log.command_output) {
            content = log.command_output;
          }
          content = content || '(no output)';
          className = 'log-skill-command-output';
          extraInfo = `–®–∞–≥: ${log.step} | Source: ${log.output_source || 'unknown'}`;
          break;
        case 'skill_message':
          typeLabel = '‚ÑπÔ∏è –ò–Ω—Ñ–æ —Å–æ–æ–±—â–µ–Ω–∏–µ';
          content = log.message || '';
          if (log.user_content_sent_to_ai) {
            content += `\n\n--- User Content Sent to AI ---\n${log.user_content_sent_to_ai}`;
          }
          if (log.ai_full_response) {
            content += `\n\n--- AI Full Response ---\n${log.ai_full_response}`;
          }
          className = 'log-skill-message';
          extraInfo = `–®–∞–≥: ${log.step}`;
          break;
        case 'skill_user_input':
          typeLabel = 'üí¨ –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
          content = log.user_input || '';
          className = 'log-skill-user-input';
          extraInfo = `–®–∞–≥: ${log.step}`;
          break;
        case 'skill_ask':
          typeLabel = '‚ùì –í–æ–ø—Ä–æ—Å AI';
          content = log.question || '';
          if (log.required === false) {
            content += ' (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π)';
          }
          if (log.user_content_sent_to_ai) {
            content += `\n\n--- User Content Sent to AI ---\n${log.user_content_sent_to_ai}`;
          }
          if (log.ai_full_response) {
            content += `\n\n--- AI Full Response ---\n${log.ai_full_response}`;
          }
          className = 'log-skill-ask';
          extraInfo = `–®–∞–≥: ${log.step}`;
          break;
        case 'skill_complete':
          typeLabel = '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ';
          content = log.final_message || 'Skill completed';
          if (log.user_content_sent_to_ai) {
            content += `\n\n--- User Content Sent to AI ---\n${log.user_content_sent_to_ai}`;
          }
          if (log.ai_full_response) {
            content += `\n\n--- AI Full Response ---\n${log.ai_full_response}`;
          }
          className = 'log-skill-complete';
          extraInfo = `–®–∞–≥: ${log.step}`;
          break;
        default:
          return '';
      }

      content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleString('ru-RU') : '';
      const sessionBadge = showAllSessions && (log.serverName || log.session_id)
        ? `<div class="log-entry-session"><span>${escapeHtml(log.serverName || log.serverId || '')}</span><span>${escapeHtml((log.session_id || '').substring(0, 8))}‚Ä¶</span></div>`
        : '';
      const skillBadge = `<div class="log-entry-session"><span>üì¶ ${escapeHtml(log.skill_name)}</span>${extraInfo ? `<span>${extraInfo}</span>` : ''}</div>`;

      return `
          <div class="log-entry ${className}">
            ${sessionBadge}
            ${skillBadge}
            <div class="log-entry-type">
              ${typeLabel}
              ${timestamp ? `<span class="timestamp">${timestamp}</span>` : ''}
            </div>
            <pre class="log-entry-content">${content}</pre>
          </div>
        `;
    }

    // –ß–µ–∫–±–æ–∫—Å All ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è / –≤—Å–µ —Å–µ—Å—Å–∏–∏
    document.getElementById('showAllSessions').addEventListener('change', function () {
      showAllSessions = this.checked;
      loadLogs();
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const tabName = tab.dataset.tab;
        if (tabName === currentTab) return;

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tabName;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const headerTitle = document.getElementById('headerTitle');
        if (tabName === 'skills') {
          headerTitle.textContent = '‚ú® –õ–æ–≥–∏ Skills';
        } else {
          headerTitle.textContent = 'üìã –õ–æ–≥ –∫–æ–º–∞–Ω–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞';
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
        document.getElementById('terminalFilters').style.display = tabName === 'terminal' ? 'flex' : 'none';
        document.getElementById('skillsFilters').style.display = tabName === 'skills' ? 'flex' : 'none';

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        currentFilter = 'all';
        const activeFilters = tabName === 'terminal' ? '#terminalFilters .filter-btn' : '#skillsFilters .filter-btn';
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(activeFilters + '[data-type="all"]').classList.add('active');

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥–∏
        allLogs = [];
        loadLogs();
      };
    });

    // –§–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.type;
        renderLogs();
        updateStatus();
      };
    });

    // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä (—Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ sessionId) –∏ –∑–∞–≥—Ä—É–∑–∫–∞
    renderLogs();
    loadLogs();
    const intervalId = setInterval(loadLogs, 2000);

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
    window.addEventListener('beforeunload', () => {
      clearInterval(intervalId);
    });
  </script>
</body>

</html>