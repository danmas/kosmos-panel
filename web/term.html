<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <style>
      html, body { height:100%; margin:0; background:#0b0f1a; color:#e6ecff; }
      .wrap { height:100%; display:flex; flex-direction:column; }
      .top { padding:8px 10px; background:#0e1322; border-bottom:1px solid #1c2333; display:flex; gap:8px; align-items:center; }
      .title { font-weight:700; }
      .term { flex:1; background:#000; }
      .bar { padding:6px 10px; background:#0e1322; border-top:1px solid #1c2333; display:flex; gap:8px; }
      button { background:#1b2544; border:1px solid #223055; color:#e6ecff; border-radius:8px; padding:6px 10px; cursor:pointer; }
      .term-container { position: relative; flex: 1; display: flex; }
      .term { flex: 1; background: #000; }
      .log-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        background: #1b2544;
        border: 1px solid #223055;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 10;
      }
      .log-indicator:hover { opacity: 1; }
      .log-indicator.active { background: #2d4a87; opacity: 1; }
      .log-panel {
        position: absolute;
        top: 0;
        right: 0;
        width: 400px;
        height: 100%;
        background: #0e1322;
        border-left: 1px solid #1c2333;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
      }
      .log-panel.visible { transform: translateX(0); }
      .log-header {
        padding: 8px 12px;
        background: #1b2544;
        border-bottom: 1px solid #223055;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        font-weight: 600;
      }
      .log-content {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.4;
      }
      .log-entry { margin-bottom: 16px; }
      .log-entry-type {
        color: #4a9eff;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .log-entry-content {
        background: #0b0f1a;
        padding: 8px;
        border-radius: 4px;
        border-left: 3px solid #4a9eff;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .log-ai-query { border-left-color: #ffa500; }
      .log-stdin { border-left-color: #00ff00; }
      .log-stdout { border-left-color: #4a9eff; }
      
      /* Remote command confirmation panel */
      .command-confirm {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, #1a2744 0%, #0e1322 100%);
        border-top: 2px solid #ffa500;
        padding: 12px 16px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.2s ease-out;
      }
      .command-confirm.hidden { display: none; }
      @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .command-confirm-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #ffa500;
        font-weight: 600;
      }
      .command-confirm-badge {
        background: #ffa500;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
      }
      .command-confirm-text {
        font-family: 'Courier New', monospace;
        background: #000;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #333;
        color: #00ff00;
        font-size: 13px;
        word-break: break-all;
        max-height: 100px;
        overflow-y: auto;
      }
      .command-confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .command-confirm-buttons button {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .btn-confirm {
        background: #22c55e;
        border: 1px solid #16a34a;
        color: #fff;
      }
      .btn-confirm:hover { background: #16a34a; }
      .btn-reject {
        background: #ef4444;
        border: 1px solid #dc2626;
        color: #fff;
      }
      .btn-reject:hover { background: #dc2626; }
      .btn-skip {
        background: #3b82f6;
        border: 1px solid #2563eb;
        color: #fff;
      }
      .btn-skip:hover { background: #2563eb; }
      
      /* Session ID indicator */
      .session-indicator {
        position: absolute;
        top: 8px;
        left: 10px;
        font-size: 11px;
        color: #4a9eff;
        font-family: monospace;
        background: rgba(0, 0, 0, 0.7);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #223055;
        z-index: 10;
        user-select: all;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .session-indicator:hover { 
        background: rgba(74, 158, 255, 0.2);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top"><div class="title" id="t"></div><button id="close">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div class="term-container">
        <div id="term" class="term"></div>
        <div class="session-indicator" id="sessionIndicator" title="Session ID –¥–ª—è REST API"></div>
        <div class="log-indicator" id="logIndicator" title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥ –∫–æ–º–∞–Ω–¥—ã">üìã</div>
        
        <!-- Remote command confirmation panel -->
        <div id="commandConfirm" class="command-confirm hidden">
          <div class="command-confirm-header">
            <span class="command-confirm-badge">REST API</span>
            <span>–£–¥–∞–ª—ë–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
          </div>
          <div class="command-confirm-text" id="commandConfirmText"></div>
          <div class="command-confirm-buttons">
            <button class="btn-reject" id="confirmNo">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            <button class="btn-skip" id="confirmSkip">–í—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</button>
            <button class="btn-confirm" id="confirmYes">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
        </div>
        <div class="log-panel" id="logPanel">
          <div class="log-header">
            <span>–õ–æ–≥ –∫–æ–º–∞–Ω–¥—ã</span>
            <button onclick="hideLogPanel()" style="background:none;border:none;color:#e6ecff;cursor:pointer;">‚úï</button>
          </div>
          <div class="log-content" id="logContent">
            <div style="color: #888; text-align: center; margin-top: 50px;">
              –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
            </div>
          </div>
        </div>
      </div>
      <div class="bar"><button id="fit">–ü–æ–¥–æ–≥–Ω–∞—Ç—å</button></div>
    </div>
    <script>
      const params = new URLSearchParams(location.search);
      const mode = params.get('mode');
      const serverId = params.get('serverId');
      const path = params.get('path') || '';
      const title = document.getElementById('t');
      title.textContent = mode === 'tail' ? `tail ${path}` : `terminal (${serverId})`;
      const termDiv = document.getElementById('term');
      const term = new Terminal({ convertEol:true, cursorBlink:true, theme:{ background:'#000000', foreground:'#00ff00' } });
      
      const fit = new window.FitAddon.FitAddon();
      term.loadAddon(fit); term.open(termDiv); setTimeout(()=>{ try{fit.fit()}catch{} },0);
      const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = mode === 'tail'
        ? `${wsProto}://${location.host}/ws/tail?serverId=${encodeURIComponent(serverId)}&path=${encodeURIComponent(path)}&lines=200`
        : `${wsProto}://${location.host}/ws/terminal?serverId=${encodeURIComponent(serverId)}&cols=120&rows=30`;
      const ws = new WebSocket(wsUrl);
      term.writeln(mode === 'tail' ? `[tail ${path}]` : '[–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SSH...]');
      ws.onopen = () => term.writeln('[—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]');
      ws.onclose = ev => {
        console.warn('[ws] closed:', ev.code, ev.reason);
        term.writeln(`\r\n[—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –∫–æ–¥ ${ev.code}${ev.reason ? ' ' + ev.reason : ''}]`);
      };
      ws.onerror = err => {
        console.error('[ws] error:', err);
        term.writeln(`\r\n[–æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è]`);
      };

      // ========== REST Bridge Variables ==========
      let currentSessionId = null;
      let pendingRemoteCommand = null;
      let remoteCommandBuffer = '';
      let remoteCommandCollecting = false;
      const promptRegex = /\w+@[\w\-\.]+[^$#>]*[\$#>]\s*$/;

      // ========== WebSocket Message Handler ==========
      ws.onmessage = ev => {
        try {
          const m = JSON.parse(ev.data);
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
          if (m.type === 'data' || m.type === 'err') {
            term.write(m.data);
            
            // –°–±–æ—Ä –≤—ã–≤–æ–¥–∞ –¥–ª—è remote –∫–æ–º–∞–Ω–¥—ã
            if (remoteCommandCollecting && pendingRemoteCommand) {
              remoteCommandBuffer += m.data;
              checkRemoteCommandCompletion();
            }
          }
          
          // Fatal error
          if (m.type === 'fatal') {
            term.writeln(`\r\n[FATAL] ${m.error}`);
          }
          
          // –ü–æ–ª—É—á–µ–Ω–∏–µ sessionId –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
          if (m.type === 'session' && m.sessionId) {
            currentSessionId = m.sessionId;
            console.log('[REST Bridge] Session ID received:', currentSessionId);
            updateSessionIndicator();
          }
          
          // Remote command –æ—Ç REST API
          if (m.type === 'remote_command') {
            handleRemoteCommand(m);
          }
          
          // –û—Ç–º–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã
          if (m.type === 'cancel_command' && m.commandId) {
            if (pendingRemoteCommand && pendingRemoteCommand.commandId === m.commandId) {
              console.log('[REST Bridge] Command cancelled:', m.commandId);
              hideCommandConfirm();
              pendingRemoteCommand = null;
              remoteCommandCollecting = false;
              remoteCommandBuffer = '';
            }
          }
        } catch (e) {
          console.error('[ws.onmessage] Error:', e);
        }
      };
      
      let aiCommandPrefix = 'ai:';

      fetch('/api/config')
        .then(res => res.json())
        .then(config => {
          if (config.aiCommandPrefix) {
            aiCommandPrefix = config.aiCommandPrefix;
          }
        })
        .catch(err => console.error('Failed to fetch AI config:', err));
        
      if (mode !== 'tail') {
        term.onData(d => { try { ws.send(JSON.stringify({ type:'data', data:d })); } catch {} });
        
        term.attachCustomKeyEventHandler((arg) => {
          if (arg.code === 'Enter' && arg.type === 'keydown') {
            const buffer = term.buffer.active;
            
            // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É —Å shell prompt
            for (let i = buffer.length - 1; i >= 0; i--) {
              const line = buffer.getLine(i).translateToString(true);
              const promptEndIndex = Math.max(line.lastIndexOf('$'), line.lastIndexOf('#'), line.lastIndexOf('>'));

              if (promptEndIndex !== -1) {
                const commandPart = line.substring(promptEndIndex + 1).trim();
                
                // –£–±–∏—Ä–∞–µ–º ANSI –∫–æ–¥—ã –∏–∑ –∫–æ–º–∞–Ω–¥—ã
                const cleanCommand = commandPart.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '').replace(/[\b\u0007]/g, '').trim();
                
                const prefixText = aiCommandPrefix.slice(0, -1);
                const prefixSep = aiCommandPrefix.slice(-1);
                const commandRegex = new RegExp(`(${prefixText}\\s*${prefixSep})`);
                
                const match = commandPart.match(commandRegex);

                if (match) {
                  // AI –∫–æ–º–∞–Ω–¥–∞
                  const aiPrompt = commandPart.substring(match.index + match[0].length).trim();
                  term.write('\r\n\x1b[1;33m–ó–∞–ø—Ä–æ—Å –∫ AI: ' + aiPrompt + '\x1b[0m\r\n');
                  
                  ws.send(JSON.stringify({ type: 'ai_query', prompt: line }));
                  return false; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É Enter
                } else if (cleanCommand) {
                  // –û–±—ã—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ - –ª–æ–≥–∏—Ä—É–µ–º –µ—ë
                  console.log(`[DEBUG] –õ–æ–≥–∏—Ä—É–µ–º –æ–±—ã—á–Ω—É—é –∫–æ–º–∞–Ω–¥—É: "${cleanCommand}"`);
                  ws.send(JSON.stringify({ type: 'command_log', command: cleanCommand }));
                }
                break; // –ù–∞—à–ª–∏ –ø—Ä–æ–º–ø—Ç, –≤—ã—Ö–æ–¥–∏–º
              }
            }
          }
          return true; // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏
        });
      }

      document.getElementById('close').onclick = () => { try { ws.close(); } catch {}; window.close(); };
      document.getElementById('fit').onclick = () => { try { fit.fit(); } catch {} };

      // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      setTimeout(() => {
        initializeLogPanel();
      }, 100);

      let currentLogEntries = [];
      let logPanelVisible = false;

      function initializeLogPanel() {
        console.log('[DEBUG] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ –ª–æ–≥–∞');
        const indicator = document.getElementById('logIndicator');
        if (!indicator) {
          console.error('[DEBUG] –≠–ª–µ–º–µ–Ω—Ç logIndicator –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          return;
        }
        console.log('[DEBUG] –≠–ª–µ–º–µ–Ω—Ç logIndicator –Ω–∞–π–¥–µ–Ω:', indicator);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        setupLogIndicatorClick();
        setupHoverEvents();
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–≥
      async function loadTerminalLog() {
        try {
          const response = await fetch('/api/logs?t=' + Date.now());
          return await response.json();
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–∞:', err);
          return [];
        }
      }

      // –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
      function findCommandAtCursor(term, row) {
        const buffer = term.buffer.active;
        console.log(`[DEBUG] –ò—â–µ–º –∫–æ–º–∞–Ω–¥—É –≤ —Å—Ç—Ä–æ–∫–µ ${row}, –¥–ª–∏–Ω–∞ –±—É—Ñ–µ—Ä–∞: ${buffer.length}`);
        
        if (row < 0 || row >= buffer.length) {
          console.log(`[DEBUG] –°—Ç—Ä–æ–∫–∞ ${row} –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –±—É—Ñ–µ—Ä–∞`);
          return null;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç - –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤–æ–∫—Ä—É–≥
        console.log(`[DEBUG] –ö–æ–Ω—Ç–µ–∫—Å—Ç –±—É—Ñ–µ—Ä–∞:`);
        for (let k = Math.max(0, row - 3); k <= Math.min(buffer.length - 1, row + 3); k++) {
          const contextLine = buffer.getLine(k).translateToString(true);
          console.log(`[DEBUG] –°—Ç—Ä–æ–∫–∞ ${k}: "${contextLine}"`);
        }

        // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–µ–¥ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π
        for (let i = row; i >= 0; i--) {
          const line = buffer.getLine(i).translateToString(true);
          const promptEndIndex = Math.max(line.lastIndexOf('$'), line.lastIndexOf('#'), line.lastIndexOf('>'));

          console.log(`[DEBUG] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫—É ${i}: "${line}", promptEndIndex: ${promptEndIndex}`);

          if (promptEndIndex !== -1) {
            // –ù–∞—à–ª–∏ —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–º–ø—Ç–æ–º, –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É
            let commandParts = [line.substring(promptEndIndex + 1).trim()];
            for (let j = i + 1; j <= row; j++) {
              commandParts.push(buffer.getLine(j).translateToString(true).trim());
            }
            const fullCommand = commandParts.join(' ').trim();
            
            // –£–±–∏—Ä–∞–µ–º ANSI-–∫–æ–¥—ã –∏ –ø—Ä–æ—á–∏–π –º—É—Å–æ—Ä
            const cleanCommand = fullCommand.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '').replace(/[\b\u0007]/g, '');
            
            console.log(`[DEBUG] –ü–æ–ª–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "${fullCommand}"`);
            console.log(`[DEBUG] –û—á–∏—â–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "${cleanCommand}"`);
            
            if (cleanCommand === '' && i === row) return ' '; 
            return cleanCommand || null;
          }
        }
        console.log(`[DEBUG] –ü—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        return null;
      }

      // –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã –≤ –±—É—Ñ–µ—Ä–µ
      function findLastCommand(term) {
        const buffer = term.buffer.active;
        console.log(`[DEBUG] –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–∞–Ω–¥—É –≤ –±—É—Ñ–µ—Ä–µ, –¥–ª–∏–Ω–∞: ${buffer.length}`);
        
        // –ò—â–µ–º —Å –∫–æ–Ω—Ü–∞ –±—É—Ñ–µ—Ä–∞
        for (let i = buffer.length - 1; i >= 0; i--) {
          const line = buffer.getLine(i).translateToString(true);
          const promptEndIndex = Math.max(line.lastIndexOf('$'), line.lastIndexOf('#'), line.lastIndexOf('>'));
          
          if (promptEndIndex !== -1) {
            console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω –ø—Ä–æ–º–ø—Ç –≤ —Å—Ç—Ä–æ–∫–µ ${i}: "${line}"`);
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ—Å–ª–µ –ø—Ä–æ–º–ø—Ç–∞
            const commandPart = line.substring(promptEndIndex + 1).trim();
            const cleanCommand = commandPart.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '').replace(/[\b\u0007]/g, '');
            
            console.log(`[DEBUG] –ü–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: "${cleanCommand}"`);
            return cleanCommand || null;
          }
        }
        
        console.log('[DEBUG] –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return null;
      }

      // –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã –≤ –ª–æ–≥–µ
      function findLastLogEntry(log) {
        console.log(`[DEBUG] –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–∞–Ω–¥—É –≤ –ª–æ–≥–µ, –≤—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${log.length}`);
        
        // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å —Ç–∏–ø–∞ 'stdin' (–∫–æ–º–∞–Ω–¥–∞)
        for (let i = log.length - 1; i >= 0; i--) {
          const entry = log[i];
          if (entry.type === 'stdin' && entry.executed_command) {
            console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: "${entry.executed_command}"`);
            return entry;
          }
        }
        
        console.log('[DEBUG] –í –ª–æ–≥–µ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥');
        return null;
      }

      // –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–≤—è–∑–µ–π –ø–æ ID)
      function findLogEntriesForCommand(log, command) {
        if (!command) return [];
        command = command.trim();
        if (!command) return [];
        
        console.log(`[DEBUG] –ò—â–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –ª–æ–≥–µ: "${command}"`);
        console.log(`[DEBUG] –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ: ${log.length}`);
        
        const entries = [];
        
        // –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é stdin –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–æ–π –∫–æ–º–∞–Ω–¥–æ–π
        const stdinEntries = log.filter(entry => 
          entry.type === 'stdin' && 
          entry.executed_command && 
          entry.executed_command.trim() === command
        );
        
        if (stdinEntries.length === 0) {
          console.log(`[DEBUG] –ö–æ–º–∞–Ω–¥–∞ "${command}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ª–æ–≥–µ`);
          return [];
        }
        
        // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é stdin –∑–∞–ø–∏—Å—å
        const lastStdin = stdinEntries[stdinEntries.length - 1];
        console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞! ID: ${lastStdin.id}`);
        
        // –ò—â–µ–º —Å–≤—è–∑–∞–Ω–Ω—É—é ai_query –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ ai_query_id
        if (lastStdin.ai_query_id) {
          const aiEntry = log.find(entry => 
            entry.type === 'ai_query' && 
            entry.id === lastStdin.ai_query_id
          );
          if (aiEntry) {
            entries.push(aiEntry);
            console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω–∞ —Å–≤—è–∑–∞–Ω–Ω–∞—è AI –∑–∞–ø–∏—Å—å: ${aiEntry.id}`);
          }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É
        entries.push(lastStdin);
        
        // –ò—â–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ stdout/stderr –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ stdin_id
        const relatedOutputs = log.filter(entry => 
          (entry.type === 'stdout' || entry.type === 'stderr') && 
          entry.stdin_id === lastStdin.id
        );
        
        if (relatedOutputs.length > 0) {
          entries.push(...relatedOutputs);
          console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ outputs: ${relatedOutputs.length}`);
        } else {
          // Fallback: —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–µ–π –±–µ–∑ —Å–≤—è–∑–µ–π
          console.log(`[DEBUG] –ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö outputs, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback`);
          const sessionId = lastStdin.sessionId;
          const stdinIndex = log.indexOf(lastStdin);
          
          for (let j = stdinIndex + 1; j < log.length; j++) {
            const nextEntry = log[j];
            if (nextEntry.sessionId === sessionId) {
              if (nextEntry.type === 'stdout' || nextEntry.type === 'stderr') {
                entries.push(nextEntry);
              } else if (nextEntry.type === 'stdin') {
                // –î–æ—à–ª–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∫–æ–º–∞–Ω–¥—ã, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
                break;
              }
            }
          }
        }
        
        console.log(`[DEBUG] –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${entries.length}`);
        return entries;
      }


      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–∞
      function displayLogEntries(entries) {
        const logContent = document.getElementById('logContent');
        
        if (entries.length === 0) {
          logContent.innerHTML = `
            <div style="color: #888; text-align: center; margin-top: 50px;">
              <div>–õ–æ–≥ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
              <div style="font-size: 11px; margin-top: 10px; opacity: 0.7;">
                –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞
              </div>
            </div>
          `;
          return;
        }
        
        const html = entries.map(entry => {
          let typeLabel, content, className;
          
          switch (entry.type) {
            case 'ai_query':
              typeLabel = 'ü§ñ AI –ó–∞–ø—Ä–æ—Å';
              content = entry.user_ai_query;
              className = 'log-ai-query';
              break;
            case 'stdin':
              typeLabel = '‚ö° –ö–æ–º–∞–Ω–¥–∞';
              content = entry.executed_command;
              className = 'log-stdin';
              break;
            case 'stdout':
              typeLabel = 'üì§ –í—ã–≤–æ–¥';
              // –£–±–∏—Ä–∞–µ–º ANSI escape codes
              content = (entry.terminal_output || '').replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '');
              className = 'log-stdout';
              break;
            case 'stderr':
              typeLabel = 'üî• –û—à–∏–±–∫–∞';
              content = (entry.terminal_output || '').replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '');
              className = 'log-stderr'; // –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–ª—å
              break;
            default:
              return '';
          }
          
          // Basic HTML escaping
          content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');

          return `
            <div class="log-entry">
              <div class="log-entry-type">${typeLabel}</div>
              <pre class="log-entry-content ${className}">${content}</pre>
            </div>
          `;
        }).join('');
        
        logContent.innerHTML = html;
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å
      function showLogPanel() {
        const panel = document.getElementById('logPanel');
        const indicator = document.getElementById('logIndicator');
        panel.classList.add('visible');
        indicator.classList.add('active');
        logPanelVisible = true;
      }

      function hideLogPanel() {
        const panel = document.getElementById('logPanel');
        const indicator = document.getElementById('logIndicator');
        panel.classList.remove('visible');
        indicator.classList.remove('active');
        logPanelVisible = false;
      }

      let lastHoveredRow = -1;
      let hoverTimeout = null;

      // –≠—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º –≤ initializeLogPanel
      function setupLogIndicatorClick() {
        const indicator = document.getElementById('logIndicator');
        if (indicator) {
          indicator.onclick = async () => {
            console.log('[DEBUG] –ö–ª–∏–∫ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ª–æ–≥–∞');
            if (logPanelVisible) {
              hideLogPanel();
            } else {
               showLogPanel();
               // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º –ª–æ–≥ –¥–ª—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
               updateLogForPosition(term.buffer.active.cursorY);
            }
          };
        }
      }

      async function updateLogForPosition(row) {
        console.log(`[DEBUG] updateLogForPosition –≤—ã–∑–≤–∞–Ω –¥–ª—è —Å—Ç—Ä–æ–∫–∏: ${row}`);
        try {
          const log = await loadTerminalLog();
          
          // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–∞–Ω–¥—É –∏–∑ –ª–æ–≥–∞
          const lastEntry = findLastLogEntry(log);
          
          if (lastEntry) {
            console.log(`[DEBUG] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–º–∞–Ω–¥—É –∏–∑ –ª–æ–≥–∞: "${lastEntry.executed_command}"`);
            const entries = findLogEntriesForCommand(log, lastEntry.executed_command);
            displayLogEntries(entries);
          } else {
            console.log('[DEBUG] –í –ª–æ–≥–µ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥');
            displayLogEntries([]);
          }
        } catch (error) {
          console.error('[DEBUG] –û—à–∏–±–∫–∞ –≤ updateLogForPosition:', error);
        }
      }

      function setupHoverEvents() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ hover –Ω–∞–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–∞
        const termElement = term.element;
        if (termElement) {
          termElement.addEventListener('mousemove', (e) => {
            try {
              const charHeight = term._core._renderService.dimensions.actualCellHeight;
              if(charHeight <= 0) return;

              const terminalRect = termElement.getBoundingClientRect();
              const relativeY = e.clientY - terminalRect.top;
              const row = Math.floor(relativeY / charHeight) + term.buffer.active.viewportY;

              if (row !== lastHoveredRow && !isNaN(row)) {
                lastHoveredRow = row;
                if (hoverTimeout) clearTimeout(hoverTimeout);
                
                hoverTimeout = setTimeout(() => {
                  if (logPanelVisible) {
                     updateLogForPosition(row);
                  }
                }, 150); // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 150ms
              }
            } catch (err) {
              console.error('[DEBUG] –û—à–∏–±–∫–∞ –≤ mousemove:', err);
            }
          });
          console.log('[DEBUG] Hover —Å–æ–±—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        } else {
          console.error('[DEBUG] term.element –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        }
      }

      // ========== REST Bridge Functions ==========
      
      function updateSessionIndicator() {
        const indicator = document.getElementById('sessionIndicator');
        if (indicator && currentSessionId) {
          indicator.textContent = `üîó Session: ${currentSessionId.substring(0, 8)}...`;
          indicator.title = `Session ID –¥–ª—è REST API:\n${currentSessionId}\n\n–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è`;
          indicator.style.display = 'block';
          indicator.onclick = () => {
            navigator.clipboard.writeText(currentSessionId).then(() => {
              const original = indicator.textContent;
              indicator.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
              indicator.style.background = 'rgba(34, 197, 94, 0.3)';
              setTimeout(() => {
                indicator.textContent = original;
                indicator.style.background = '';
              }, 1500);
            });
          };
          
          // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
          term.writeln(`\x1b[90m[Session ID: ${currentSessionId}]\x1b[0m`);
        }
      }

      function handleRemoteCommand(msg) {
        console.log('[REST Bridge] Remote command received:', msg);
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
        term.writeln(`\r\n\x1b[1;45;97m ‚ö° REST API COMMAND ‚ö° \x1b[0m`);
        term.writeln(`\x1b[1;35mCommand ID:\x1b[0m ${msg.commandId}`);
        term.writeln(`\x1b[1;35mCommand:\x1b[0m \x1b[1;33m${msg.command}\x1b[0m`);
        term.writeln(`\x1b[1;35mConfirmation:\x1b[0m ${msg.requireConfirmation ? 'Required' : 'Not required'}`);
        
        pendingRemoteCommand = {
          commandId: msg.commandId,
          command: msg.command,
          requireConfirmation: msg.requireConfirmation
        };

        if (msg.requireConfirmation) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
          showCommandConfirm(msg.command);
        } else {
          // –í—ã–ø–æ–ª–Ω—è–µ–º —Å—Ä–∞–∑—É
          executeRemoteCommand(msg.command);
        }
      }

      function showCommandConfirm(command) {
        const panel = document.getElementById('commandConfirm');
        const textEl = document.getElementById('commandConfirmText');
        
        textEl.textContent = command;
        panel.classList.remove('hidden');
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
        term.writeln('\r\n\x1b[1;33m[REST API] –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...\x1b[0m');
      }

      function hideCommandConfirm() {
        const panel = document.getElementById('commandConfirm');
        panel.classList.add('hidden');
      }

      function executeRemoteCommand(command) {
        console.log('[REST Bridge] Executing command:', command);
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –≤—ã–≤–æ–¥–∞
        remoteCommandBuffer = '';
        remoteCommandCollecting = true;
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        term.writeln(`\r\n\x1b[1;36m[REST API] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${command}\x1b[0m`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
        try {
          ws.send(JSON.stringify({ type: 'data', data: command + '\r' }));
        } catch (e) {
          console.error('[REST Bridge] Failed to send command:', e);
          sendCommandResult('error', '', 'Failed to send command: ' + e.message, null);
        }
      }

      function checkRemoteCommandCompletion() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª—Å—è –ª–∏ –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç (–∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å)
        const cleanBuffer = stripAnsiCodes(remoteCommandBuffer);
        
        if (promptRegex.test(cleanBuffer)) {
          // –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
          console.log('[REST Bridge] Command completed, prompt detected');
          
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—ã–≤–æ–¥ (–±–µ–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–æ–º–ø—Ç–æ–º)
          const lines = cleanBuffer.split('\n');
          let outputLines = [];
          let foundPrompt = false;
          
          for (let i = lines.length - 1; i >= 0; i--) {
            if (promptRegex.test(lines[i])) {
              foundPrompt = true;
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–æ–º–ø—Ç–æ–º –∏ –≤—Å–µ —á—Ç–æ –ø–æ—Å–ª–µ
              outputLines = lines.slice(0, i);
              break;
            }
          }
          
          // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –æ–±—ã—á–Ω–æ —ç—Ö–æ –∫–æ–º–∞–Ω–¥—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if (outputLines.length > 0) {
            outputLines = outputLines.slice(1);
          }
          
          const stdout = outputLines.join('\n').trim();
          
          sendCommandResult('completed', stdout, '', 0);
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          remoteCommandCollecting = false;
          remoteCommandBuffer = '';
          pendingRemoteCommand = null;
        }
      }

      function sendCommandResult(status, stdout, stderr, exitCode) {
        if (!pendingRemoteCommand) return;
        
        const result = {
          type: 'command_result',
          commandId: pendingRemoteCommand.commandId,
          status: status,
          stdout: stdout,
          stderr: stderr,
          exitCode: exitCode
        };
        
        console.log('[REST Bridge] Sending result:', result);
        
        try {
          ws.send(JSON.stringify(result));
        } catch (e) {
          console.error('[REST Bridge] Failed to send result:', e);
        }
      }

      function stripAnsiCodes(str) {
        return str.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
      }

      // ========== Command Confirm Button Handlers ==========
      document.getElementById('confirmYes').onclick = () => {
        if (pendingRemoteCommand) {
          hideCommandConfirm();
          executeRemoteCommand(pendingRemoteCommand.command);
        }
      };

      document.getElementById('confirmNo').onclick = () => {
        if (pendingRemoteCommand) {
          term.writeln('\r\n\x1b[1;31m[REST API] –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º\x1b[0m');
          sendCommandResult('rejected', '', 'Command rejected by user', null);
          hideCommandConfirm();
          pendingRemoteCommand = null;
        }
      };

      document.getElementById('confirmSkip').onclick = () => {
        if (pendingRemoteCommand) {
          hideCommandConfirm();
          // –í—ã–ø–æ–ª–Ω—è–µ–º –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
          executeRemoteCommand(pendingRemoteCommand.command);
        }
      };
    </script>
  </body>
</html>


