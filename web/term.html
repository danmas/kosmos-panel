<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <style>
      html, body { height:100%; margin:0; background:#0b0f1a; color:#e6ecff; }
      .wrap { height:100%; display:flex; flex-direction:column; }
      .top { padding:8px 10px; background:#0e1322; border-bottom:1px solid #1c2333; display:flex; gap:8px; align-items:center; }
      .title { font-weight:700; }
      .term { flex:1; background:#000; }
      .bar { padding:6px 10px; background:#0e1322; border-top:1px solid #1c2333; display:flex; gap:8px; }
      button { background:#1b2544; border:1px solid #223055; color:#e6ecff; border-radius:8px; padding:6px 10px; cursor:pointer; }
      .term-container { position: relative; flex: 1; display: flex; }
      .term { flex: 1; background: #000; }
      .log-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        background: #1b2544;
        border: 1px solid #223055;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 10;
      }
      .log-indicator:hover { opacity: 1; }
      
      /* Remote command confirmation panel */
      .command-confirm {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, #1a2744 0%, #0e1322 100%);
        border-top: 2px solid #ffa500;
        padding: 12px 16px;
        z-index: 1001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.2s ease-out;
      }
      .command-confirm.hidden { display: none; }
      @keyframes slideUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      .command-confirm-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #ffa500;
        font-weight: 600;
      }
      .command-confirm-badge {
        background: #ffa500;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
      }
      .command-confirm-text {
        font-family: 'Courier New', monospace;
        background: #000;
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid #333;
        color: #00ff00;
        font-size: 13px;
        word-break: break-all;
        max-height: 100px;
        overflow-y: auto;
      }
      .command-confirm-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .command-confirm-buttons button {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .btn-confirm {
        background: #22c55e;
        border: 1px solid #16a34a;
        color: #fff;
      }
      .btn-confirm:hover { background: #16a34a; }
      .btn-reject {
        background: #ef4444;
        border: 1px solid #dc2626;
        color: #fff;
      }
      .btn-reject:hover { background: #dc2626; }
      .btn-skip {
        background: #3b82f6;
        border: 1px solid #2563eb;
        color: #fff;
      }
      .btn-skip:hover { background: #2563eb; }
      
      /* Session ID indicator */
      .session-indicator {
        position: absolute;
        top: 8px;
        right: 45px;
        font-size: 11px;
        color: #4a9eff;
        font-family: monospace;
        background: rgba(0, 0, 0, 0.7);
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #223055;
        z-index: 10;
        user-select: all;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .session-indicator:hover { 
        background: rgba(74, 158, 255, 0.2);
        color: #fff;
      }
      #reconnect { 
        background: #22c55e; 
        border-color: #16a34a; 
      }
      #reconnect:hover { 
        background: #16a34a; 
      }
      
      /* Skills popup - draggable dialog */
      .skills-popup {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
        max-width: 90%;
        max-height: 70%;
        background: linear-gradient(180deg, #1a2744 0%, #0e1322 100%);
        border: 2px solid #4a9eff;
        border-radius: 8px;
        padding: 0;
        z-index: 1002;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .skills-popup.hidden { display: none; }
      .skills-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-size: 14px;
        color: #4a9eff;
        font-weight: 600;
        padding: 10px 16px;
        background: #0e1322;
        border-bottom: 1px solid #223055;
        cursor: move;
        user-select: none;
      }
      .skills-close {
        background: transparent;
        border: none;
        color: #888;
        font-size: 20px;
        cursor: pointer;
        padding: 0 4px;
      }
      .skills-close:hover { color: #fff; }
      .skills-body {
        padding: 12px 16px;
        max-height: 300px;
        overflow-y: auto;
      }
      .skills-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .skill-item {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .skill-item:hover {
        background: rgba(74, 158, 255, 0.2);
        border-color: #4a9eff;
      }
      .skill-name {
        font-weight: 600;
        color: #00ff00;
        font-family: monospace;
        margin-bottom: 4px;
      }
      .skill-desc {
        font-size: 12px;
        color: #aaa;
      }
      .skills-empty {
        color: #666;
        text-align: center;
        padding: 20px;
      }
      .skills-loading {
        color: #4a9eff;
        text-align: center;
        padding: 20px;
      }
      .skill-params-form {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #333;
      }
      .skill-params-form.hidden { display: none; }
      .skill-params-title {
        color: #4a9eff;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .skill-param-input {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .skill-param-input input {
        flex: 1;
        background: #000;
        border: 1px solid #333;
        color: #00ff00;
        padding: 8px 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      .skill-param-input input:focus {
        outline: none;
        border-color: #4a9eff;
      }
      .skill-execute-btn {
        background: #22c55e;
        border: 1px solid #16a34a;
        color: #fff;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .skill-execute-btn:hover { background: #16a34a; }
      
      /* Skill input panel for multi-step skills */
      .skill-input-panel {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, #1a2744 0%, #0e1322 100%);
        border-top: 2px solid #22c55e;
        padding: 12px 16px;
        z-index: 1003;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        animation: slideUp 0.2s ease-out;
      }
      .skill-input-panel.hidden { display: none; }
      .skill-input-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #22c55e;
        font-weight: 600;
        margin-bottom: 10px;
      }
      .skill-input-badge {
        background: #22c55e;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
      }
      .skill-input-form {
        display: flex;
        gap: 8px;
      }
      .skill-input-form input {
        flex: 1;
        background: #000;
        border: 1px solid #333;
        color: #00ff00;
        padding: 10px 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 14px;
      }
      .skill-input-form input:focus {
        outline: none;
        border-color: #22c55e;
      }
      .skill-execute-btn:hover { background: #16a34a; }
      
      /* Skills button - –ø–æ–¥ Session indicator */
      .skills-btn {
        position: absolute;
        top: 32px;
        right: 45px;
        background: #1b2544;
        border: 1px solid #4a9eff;
        color: #4a9eff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        z-index: 10;
        transition: all 0.15s ease;
      }
      .skills-btn:hover {
        background: rgba(74, 158, 255, 0.2);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div class="title" id="t"></div>
        <button id="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button id="fit">–ü–æ–¥–æ–≥–Ω–∞—Ç—å</button>
        <button id="reconnect" style="display:none;">–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å</button>
      </div>
      <div class="term-container">
        <div id="term" class="term"></div>
        <div class="session-indicator" id="sessionIndicator" title="Session ID –¥–ª—è REST API"></div>
        <button class="skills-btn" id="skillsBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ Skills">Skills</button>
        <div class="log-indicator" id="logIndicator" title="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥ –∫–æ–º–∞–Ω–¥—ã">üìã</div>
        
        <!-- Remote command confirmation panel -->
        <div id="commandConfirm" class="command-confirm hidden">
          <div class="command-confirm-header">
            <span class="command-confirm-badge">REST API</span>
            <span>–£–¥–∞–ª—ë–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
          </div>
          <div class="command-confirm-text" id="commandConfirmText"></div>
          <div class="command-confirm-buttons">
            <button class="btn-reject" id="confirmNo">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            <button class="btn-skip" id="confirmSkip">–í—ã–ø–æ–ª–Ω–∏—Ç—å –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</button>
            <button class="btn-confirm" id="confirmYes">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
          </div>
        </div>
        
        <!-- Skills popup (draggable) -->
        <div id="skillsPopup" class="skills-popup hidden">
          <div class="skills-header" id="skillsHeader">
            <span>Skills <span id="skillProgress" style="font-weight:normal;font-size:12px;color:#888;"></span></span>
            <button class="skills-close" id="skillsClose">√ó</button>
          </div>
          <div class="skills-body">
            <div class="skills-list" id="skillsList">
              <div class="skills-loading">–ó–∞–≥—Ä—É–∑–∫–∞ skills...</div>
            </div>
            <div class="skill-params-form hidden" id="skillParamsForm">
              <div class="skill-params-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è <span id="skillParamsName"></span>:</div>
              <div class="skill-param-input">
                <input type="text" id="skillParamsInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="skill-execute-btn" id="skillExecuteBtn">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Skill input panel (for multi-step skills) -->
        <div id="skillInputPanel" class="skill-input-panel hidden">
          <div class="skill-input-header">
            <span class="skill-input-badge">Skill</span>
            <span id="skillInputQuestion">Waiting for input...</span>
          </div>
          <div class="skill-input-form">
            <input type="text" id="skillUserInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
            <button class="btn-confirm" id="skillInputSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button class="btn-reject" id="skillInputCancel">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const params = new URLSearchParams(location.search);
      const mode = params.get('mode');
      const serverId = params.get('serverId');
      const path = params.get('path') || '';
      const title = document.getElementById('t');
      title.textContent = mode === 'tail' ? `tail ${path}` : `terminal (${serverId})`;
      const termDiv = document.getElementById('term');
      const term = new Terminal({ convertEol:true, cursorBlink:true, theme:{ background:'#000000', foreground:'#00ff00' } });
      
      const fit = new window.FitAddon.FitAddon();
      term.loadAddon(fit); term.open(termDiv); setTimeout(()=>{ try{fit.fit()}catch{} },0);
      
      // ========== Resize Support ==========
      function sendResize() {
        if (ws.readyState === WebSocket.OPEN && mode !== 'tail') {
          ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
        }
      }
      
      let resizeTimeout;
      function handleResize() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          try { fit.fit(); sendResize(); } catch (e) {}
        }, 100);
      }
      
      window.addEventListener('resize', handleResize);
      if (typeof ResizeObserver !== 'undefined') {
        new ResizeObserver(handleResize).observe(termDiv);
      }
      
      const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = mode === 'tail'
        ? `${wsProto}://${location.host}/ws/tail?serverId=${encodeURIComponent(serverId)}&path=${encodeURIComponent(path)}&lines=200`
        : `${wsProto}://${location.host}/ws/terminal?serverId=${encodeURIComponent(serverId)}&cols=120&rows=30`;
      const ws = new WebSocket(wsUrl);
      term.writeln(mode === 'tail' ? `[tail ${path}]` : '[–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SSH...]');
      
      ws.onopen = () => {
        term.writeln('[—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ]');
        setTimeout(() => { try { fit.fit(); } catch {} sendResize(); }, 100);
      };
      ws.onclose = ev => {
        term.writeln(`\r\n[—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –∫–æ–¥ ${ev.code}${ev.reason ? ' ' + ev.reason : ''}]`);
        document.getElementById('reconnect').style.display = 'inline-block';
      };
      ws.onerror = () => term.writeln(`\r\n[–æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è]`);

      // ========== REST Bridge Variables ==========
      let currentSessionId = null;
      let pendingRemoteCommand = null;
      let remoteCommandBuffer = '';
      let remoteCommandCollecting = false;
      const promptRegex = /\w+@[\w\-\.]+[^$#>]*[\$#>]\s*$/;

      // ========== AI Config ==========
      let aiCommandPrefix = 'ai:';
      fetch('/api/config')
        .then(res => res.json())
        .then(config => { if (config.aiCommandPrefix) aiCommandPrefix = config.aiCommandPrefix; })
        .catch(() => {});

      // ========== WebSocket Message Handler ==========
      ws.onmessage = ev => {
        try {
          const m = JSON.parse(ev.data);
          
          if (m.type === 'data' || m.type === 'err') {
            term.write(m.data);
            if (remoteCommandCollecting && pendingRemoteCommand) {
              remoteCommandBuffer += m.data;
              checkRemoteCommandCompletion();
            }
          }
          
          if (m.type === 'fatal') term.writeln(`\r\n[FATAL] ${m.error}`);
          
          if (m.type === 'session' && m.sessionId) {
            currentSessionId = m.sessionId;
            updateSessionIndicator();
          }
          
          if (m.type === 'remote_command') handleRemoteCommand(m);
          
          if (m.type === 'cancel_command' && m.commandId) {
            if (pendingRemoteCommand && pendingRemoteCommand.commandId === m.commandId) {
              hideCommandConfirm();
              pendingRemoteCommand = null;
              remoteCommandCollecting = false;
              remoteCommandBuffer = '';
            }
          }
          
          // Skills responses
          if (m.type === 'skills_list') handleSkillsList(m.skills || [], m.error);
          if (m.type === 'skill_error') {
            term.writeln(`\r\n\x1b[1;31m[Skill Error] ${m.error}\x1b[0m`);
            hideSkillsPopup();
            skillActive = false;
          }
          if (m.type === 'skill_step') {
            skillActive = true;
            updateSkillProgress(m.step, m.max);
          }
          if (m.type === 'skill_message') {
            showSkillInput(m.text);
          }
          if (m.type === 'skill_complete') {
            skillActive = false;
            hideSkillInput();
            hideSkillsPopup();
          }
        } catch (e) {
          console.error('[ws.onmessage] Error:', e);
        }
      };

      // ========== Terminal Input ==========
      if (mode !== 'tail') {
        term.onData(d => { 
          try { ws.send(JSON.stringify({ type: 'data', data: d })); } catch {} 
        });
        
        term.attachCustomKeyEventHandler((arg) => {
          if (arg.code === 'Enter' && arg.type === 'keydown') {
            const buffer = term.buffer.active;
            for (let i = buffer.length - 1; i >= 0; i--) {
              const line = buffer.getLine(i).translateToString(true);
              const promptEndIndex = Math.max(line.lastIndexOf('$'), line.lastIndexOf('#'), line.lastIndexOf('>'));
              if (promptEndIndex !== -1) {
                const commandPart = line.substring(promptEndIndex + 1).trim();
                const cleanCommand = commandPart.replace(/\x1b\[[0-9;?]*[a-zA-Z]/g, '').replace(/[\b\u0007]/g, '').trim();
                
                const prefixText = aiCommandPrefix.slice(0, -1);
                const prefixSep = aiCommandPrefix.slice(-1);
                const commandRegex = new RegExp(`(${prefixText}\\s*${prefixSep})`);
                const match = commandPart.match(commandRegex);

                if (match) {
                  const aiPrompt = commandPart.substring(match.index + match[0].length).trim();
                  // –í–∏–∑—É–∞–ª—å–Ω—ã–π feedback - –∂–µ–ª—Ç—ã–π –≤—ã–≤–æ–¥ AI –∑–∞–ø—Ä–æ—Å–∞ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                  setTimeout(() => {
                    term.writeln(`\r\n\x1b[1;33m[AI] –ó–∞–ø—Ä–æ—Å: ${aiPrompt}\x1b[0m`);
                  }, 50);
                  ws.send(JSON.stringify({ type: 'ai_query', prompt: line }));
                  return true; // –†–∞–∑—Ä–µ—à–∞–µ–º Enter –¥–ª—è AI –∫–æ–º–∞–Ω–¥
                } else if (cleanCommand) {
                  ws.send(JSON.stringify({ type: 'command_log', command: cleanCommand }));
                }
                break;
              }
            }
          }
          return true;
        });
      }

      // ========== UI Handlers ==========
      document.getElementById('close').onclick = () => { try { ws.close(); } catch {}; window.close(); };
      document.getElementById('fit').onclick = () => { try { fit.fit(); sendResize(); } catch {} };
      document.getElementById('reconnect').onclick = () => location.reload();

      document.getElementById('logIndicator').onclick = () => {
        if (currentSessionId) {
          window.open(`/logs.html?sessionId=${encodeURIComponent(currentSessionId)}`, 'terminal-logs', 'width=800,height=600');
        } else {
          term.writeln('\r\n\x1b[1;33m[INFO] Session ID –µ—â–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω\x1b[0m');
        }
      };

      // ========== REST Bridge Functions ==========
      function updateSessionIndicator() {
        const indicator = document.getElementById('sessionIndicator');
        if (indicator && currentSessionId) {
          indicator.textContent = `Session: ${currentSessionId.substring(0, 8)}...`;
          indicator.title = `Session ID: ${currentSessionId}\n–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è`;
          indicator.style.display = 'block';
          indicator.onclick = () => {
            navigator.clipboard.writeText(currentSessionId).then(() => {
              const original = indicator.textContent;
              indicator.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
              indicator.style.background = 'rgba(34, 197, 94, 0.3)';
              setTimeout(() => { indicator.textContent = original; indicator.style.background = ''; }, 1500);
            });
          };
          term.writeln(`\x1b[90m[Session ID: ${currentSessionId}]\x1b[0m`);
        }
      }

      function handleRemoteCommand(msg) {
        term.writeln(`\r\n\x1b[1;45;97m ‚ö° REST API COMMAND ‚ö° \x1b[0m`);
        term.writeln(`\x1b[1;35mCommand:\x1b[0m \x1b[1;33m${msg.command}\x1b[0m`);
        pendingRemoteCommand = { commandId: msg.commandId, command: msg.command, requireConfirmation: msg.requireConfirmation };
        if (msg.requireConfirmation) showCommandConfirm(msg.command);
        else executeRemoteCommand(msg.command);
      }

      function showCommandConfirm(command) {
        document.getElementById('commandConfirmText').textContent = command;
        document.getElementById('commandConfirm').classList.remove('hidden');
        term.writeln('\r\n\x1b[1;33m[REST API] –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...\x1b[0m');
      }

      function hideCommandConfirm() {
        document.getElementById('commandConfirm').classList.add('hidden');
      }

      function executeRemoteCommand(command) {
        remoteCommandBuffer = '';
        remoteCommandCollecting = true;
        term.writeln(`\r\n\x1b[1;36m[REST API] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${command}\x1b[0m`);
        try { ws.send(JSON.stringify({ type: 'data', data: command + '\r' })); } 
        catch (e) { sendCommandResult('error', '', 'Failed: ' + e.message, null); }
      }

      function checkRemoteCommandCompletion() {
        const cleanBuffer = remoteCommandBuffer.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
        if (promptRegex.test(cleanBuffer)) {
          const lines = cleanBuffer.split('\n');
          let outputLines = [];
          for (let i = lines.length - 1; i >= 0; i--) {
            if (promptRegex.test(lines[i])) { outputLines = lines.slice(0, i); break; }
          }
          if (outputLines.length > 0) outputLines = outputLines.slice(1);
          sendCommandResult('completed', outputLines.join('\n').trim(), '', 0);
          remoteCommandCollecting = false;
          remoteCommandBuffer = '';
          pendingRemoteCommand = null;
        }
      }

      function sendCommandResult(status, stdout, stderr, exitCode) {
        if (!pendingRemoteCommand) return;
        try { ws.send(JSON.stringify({ type: 'command_result', commandId: pendingRemoteCommand.commandId, status, stdout, stderr, exitCode })); } catch {}
      }

      document.getElementById('confirmYes').onclick = () => { if (pendingRemoteCommand) { hideCommandConfirm(); executeRemoteCommand(pendingRemoteCommand.command); } };
      document.getElementById('confirmNo').onclick = () => { if (pendingRemoteCommand) { term.writeln('\r\n\x1b[1;31m[REST API] –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞\x1b[0m'); sendCommandResult('rejected', '', 'Rejected by user', null); hideCommandConfirm(); pendingRemoteCommand = null; } };
      document.getElementById('confirmSkip').onclick = () => { if (pendingRemoteCommand) { hideCommandConfirm(); executeRemoteCommand(pendingRemoteCommand.command); } };

      // ========== Skills Functions ==========
      let availableSkills = [];
      let selectedSkill = null;
      let skillActive = false;

      function updateSkillProgress(step, max) {
        const el = document.getElementById('skillProgress');
        if (el) el.textContent = `(—à–∞–≥ ${step}/${max})`;
      }

      function showSkillInput(question) {
        const panel = document.getElementById('skillInputPanel');
        const questionEl = document.getElementById('skillInputQuestion');
        const inputEl = document.getElementById('skillUserInput');
        
        questionEl.textContent = question;
        inputEl.value = '';
        panel.classList.remove('hidden');
        inputEl.focus();
      }

      function hideSkillInput() {
        document.getElementById('skillInputPanel').classList.add('hidden');
        document.getElementById('skillProgress').textContent = '';
      }

      function sendSkillUserInput() {
        const inputEl = document.getElementById('skillUserInput');
        const text = inputEl.value.trim();
        if (!text) return;
        
        ws.send(JSON.stringify({ type: 'skill_user_input', text }));
        hideSkillInput();
      }

      function cancelSkill() {
        ws.send(JSON.stringify({ type: 'skill_cancel' }));
        hideSkillInput();
        skillActive = false;
      }

      function showSkillsPopup() {
        const popup = document.getElementById('skillsPopup');
        // –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –Ω–∞ —Ü–µ–Ω—Ç—Ä
        popup.style.left = '50%';
        popup.style.top = '50%';
        popup.style.transform = 'translate(-50%, -50%)';
        popup.classList.remove('hidden');
        document.getElementById('skillsList').innerHTML = '<div class="skills-loading">–ó–∞–≥—Ä—É–∑–∫–∞ skills...</div>';
        document.getElementById('skillParamsForm').classList.add('hidden');
        ws.send(JSON.stringify({ type: 'skills_list' }));
      }

      function hideSkillsPopup() {
        document.getElementById('skillsPopup').classList.add('hidden');
        document.getElementById('skillParamsForm').classList.add('hidden');
        selectedSkill = null;
      }

      function handleSkillsList(skills, error) {
        availableSkills = skills;
        const listEl = document.getElementById('skillsList');
        
        if (error) {
          listEl.innerHTML = `<div class="skills-empty">–û—à–∏–±–∫–∞: ${error}</div>`;
          return;
        }
        
        if (skills.length === 0) {
          listEl.innerHTML = `<div class="skills-empty">
            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö skills.<br>
            <small style="color:#666">–°–æ–∑–¥–∞–π—Ç–µ ~/.config/kosmos-panel/skills/&lt;name&gt;/SKILL.md</small>
          </div>`;
          return;
        }
        
        listEl.innerHTML = skills.map(skill => `
          <div class="skill-item" data-skill="${skill.name}">
            <div class="skill-name">${skill.name}</div>
            <div class="skill-desc">${skill.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
          </div>
        `).join('');
        
        listEl.querySelectorAll('.skill-item').forEach(item => {
          item.onclick = () => selectSkill(item.dataset.skill);
        });
      }

      function selectSkill(skillName) {
        selectedSkill = availableSkills.find(s => s.name === skillName);
        if (!selectedSkill) return;
        
        const paramsForm = document.getElementById('skillParamsForm');
        document.getElementById('skillParamsName').textContent = skillName;
        document.getElementById('skillParamsInput').value = '';
        document.getElementById('skillParamsInput').placeholder = selectedSkill.params && selectedSkill.params.length > 0 
          ? `–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${selectedSkill.params.map(p => p.name).join(', ')}`
          : '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)';
        
        paramsForm.classList.remove('hidden');
        document.getElementById('skillParamsInput').focus();
      }

      function executeSelectedSkill() {
        if (!selectedSkill) return;
        
        const userInput = document.getElementById('skillParamsInput').value.trim();
        
        term.writeln(`\r\n\x1b[1;36m[Skill: ${selectedSkill.name}] ${selectedSkill.description || ''}\x1b[0m`);
        
        const params = parseSkillParams(userInput);
        ws.send(JSON.stringify({ 
          type: 'skill_invoke', 
          name: selectedSkill.name, 
          params: params,
          prompt: userInput 
        }));
        
        hideSkillsPopup();
      }

      function parseSkillParams(str) {
        const params = {};
        if (!str) return params;
        const regex = /--(\w+)\s+(?:"([^"]+)"|(\S+))/g;
        let match;
        while ((match = regex.exec(str)) !== null) {
          params[match[1]] = match[2] || match[3];
        }
        if (Object.keys(params).length === 0 && str) {
          params.message = str;
        }
        return params;
      }

      // Skills popup event handlers
      document.getElementById('skillsBtn').onclick = showSkillsPopup;
      document.getElementById('skillsClose').onclick = hideSkillsPopup;
      document.getElementById('skillExecuteBtn').onclick = executeSelectedSkill;
      document.getElementById('skillParamsInput').onkeydown = (e) => {
        if (e.key === 'Enter') executeSelectedSkill();
        else if (e.key === 'Escape') hideSkillsPopup();
      };
      
      // Skill input panel event handlers
      document.getElementById('skillInputSend').onclick = sendSkillUserInput;
      document.getElementById('skillInputCancel').onclick = cancelSkill;
      document.getElementById('skillUserInput').onkeydown = (e) => {
        if (e.key === 'Enter') sendSkillUserInput();
        else if (e.key === 'Escape') cancelSkill();
      };
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideSkillsPopup();
          if (skillActive) cancelSkill();
        }
      });

      // ========== Draggable Skills Popup ==========
      (function() {
        const popup = document.getElementById('skillsPopup');
        const header = document.getElementById('skillsHeader');
        let isDragging = false;
        let startX, startY, startLeft, startTop;

        header.addEventListener('mousedown', (e) => {
          if (e.target.closest('.skills-close')) return;
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          const rect = popup.getBoundingClientRect();
          startLeft = rect.left;
          startTop = rect.top;
          popup.style.transform = 'none';
          popup.style.left = startLeft + 'px';
          popup.style.top = startTop + 'px';
          document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          popup.style.left = Math.max(0, Math.min(window.innerWidth - popup.offsetWidth, startLeft + dx)) + 'px';
          popup.style.top = Math.max(0, Math.min(window.innerHeight - popup.offsetHeight, startTop + dy)) + 'px';
        });

        document.addEventListener('mouseup', () => {
          isDragging = false;
          document.body.style.userSelect = '';
        });
      })();
    </script>
  </body>
</html>
